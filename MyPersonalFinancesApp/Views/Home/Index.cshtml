@model FinanceManager.Models.DashboardViewModel
@using System.Text.Json
@using Microsoft.AspNetCore.Mvc.Localization
@using FinanceManager.Models.Resources
@using Microsoft.Extensions.Localization

@inject IViewLocalizer Localizer
@inject IStringLocalizer<SharedResource> SharedLocalizer

@{
    ViewData["Title"] = Localizer["Dashboard"];
}

<!-- MASTER FILTER FORM -->
<form asp-action="Index" method="get" id="filterForm">
    <!-- Account Filter Dropdown -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <label class="input-group-text">@Localizer["Account"]:</label>
                <select name="accountId" asp-for="SelectedAccountId" class="form-select" id="accountIdSelect">
                    <option value="">@Localizer["GeneralAll"]</option>
                    @if (Model.Accounts != null)
                    {
                        @foreach (var account in Model.Accounts)
                        {
                            <option value="@account.Value">@account.Text</option>
                        }
                    }
                    <option disabled>------------------</option>
                    <option value="create_new">@Localizer["CreateNewAcc"]</option>
                </select>
            </div>
        </div>
    </div>

    <!-- CURRENT AMOUNT & TIME FILTER BOX -->
    <div class="dashboard-box text-center mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="text-muted">@Localizer["CurrentAmount"]</h5>
                <h2>@Model.CurrentAmount.ToString("C")</h2>
            </div>
            <div class="col-md-4">
                <div class="input-group">
                    <label class="input-group-text">@Localizer["Period"]:</label>
                    <select name="selectedTimePeriod" asp-for="SelectedTimePeriod" asp-items="Html.GetEnumSelectList<TimePeriod>()" class="form-select" id="timePeriodSelect"></select>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="row">
    <!-- WEST SIDE: Expenses -->
    <div class="col-md-6 mb-4">
        <div class="dashboard-box chart-box mb-3">
            <h3 class="text-center">@SharedLocalizer["Expenses"]</h3>
            <div class="pie-chart-container">
                <canvas id="expenseChart"></canvas>
            </div>
            <a asp-controller="Transaction" asp-action="Create" asp-route-type="Expense" class="create-transaction-btn">+</a>
        </div>
        <div class="dashboard-box">
            <h5 class="mt-1">@Localizer["RecentExpenses"]</h5>
            <a asp-controller="Transaction" asp-action="Index" asp-route-type="Expense" class="stretched-link"></a>
            @if (Model.RecentExpenses.Any())
            {
                <ul class="list-group list-group-flush">
                    @foreach (var expense in Model.RecentExpenses)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div><strong>@expense.Category.Name</strong><small class="d-block text-muted">@expense.Date.ToShortDateString()</small></div>
                            <span class="badge bg-danger rounded-pill">-@expense.Amount.ToString("C")</span>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p class="text-center text-muted mt-3">@Localizer["NoExpensesFound"]</p>
            }
            @if (Model.TotalExpenseCountForPeriod > 20)
            {
                <div class="text-center text-muted mt-2">
                    @Localizer.GetString("AndMore", Model.TotalExpenseCountForPeriod - 20)
                </div>
            }
        </div>
    </div>

    <!-- EAST SIDE: Income -->
    <div class="col-md-6 mb-4">
        <div class="dashboard-box chart-box mb-3">
            <h3 class="text-center">@SharedLocalizer["Income"]</h3>
            <div class="pie-chart-container">
                <canvas id="incomeChart"></canvas>
            </div>
            <a asp-controller="Transaction" asp-action="Create" asp-route-type="Income" class="create-transaction-btn">+</a>
        </div>
        <div class="dashboard-box">
            <h5 class="mt-1">@Localizer["RecentIncome"]</h5>
            <a asp-controller="Transaction" asp-action="Index" asp-route-type="Income" class="stretched-link"></a>
            @if (Model.RecentIncomes.Any())
            {
                <ul class="list-group list-group-flush">
                    @foreach (var income in Model.RecentIncomes)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div><strong>@income.Category.Name</strong><small class="d-block text-muted">@income.Date.ToShortDateString()</small></div>
                            <span class="badge bg-success rounded-pill">+@income.Amount.ToString("C")</span>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p class="text-center text-muted mt-3">@Localizer["NoIncomeFound"]</p>
            }
            @if (Model.TotalIncomeCountForPeriod > 20)
            {
                <div class="text-center text-muted mt-2">
                    @Localizer.GetString("AndMore", Model.TotalIncomeCountForPeriod - 20)
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // --- Reusable function for the placeholder chart ---
        function createPlaceholderChart(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['No Data'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#E9ECEF'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: { enabled: false },
                        legend: { display: false }
                    }
                }
            });
        }

        // --- CUSTOM CHART.JS PLUGIN to draw text in the center ---
        const doughnutCenterText = {
            id: 'doughnutCenterText',
            afterDraw: (chart) => {
                if (chart.options.plugins.doughnutCenterText.text) {
                    const ctx = chart.ctx;
                    const text = chart.options.plugins.doughnutCenterText.text;
                    const holeRadius = chart.innerRadius;
                    const maxTextWidth = (holeRadius * 2) - 20;

                    ctx.save();
                    ctx.font = 'bold 1.2em sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#6c757d';

                    let textToDraw = text;
                    if (ctx.measureText(textToDraw).width > maxTextWidth) {
                        while (ctx.measureText(textToDraw + '...').width > maxTextWidth && textToDraw.length > 0) {
                            textToDraw = textToDraw.slice(0, -1);
                        }
                        textToDraw += '...';
                    }

                    const x = (chart.chartArea.left + chart.chartArea.right) / 2;
                    const y = (chart.chartArea.top + chart.chartArea.bottom) / 2;
                    ctx.fillText(textToDraw, x, y);
                    ctx.restore();
                }
            }
        };

        // --- MAIN SCRIPT EXECUTION on page load ---
        document.addEventListener('DOMContentLoaded', function () {

            // --- FORM FILTER HANDLING ---
            const accountSelect = document.getElementById('accountIdSelect');
            const timePeriodSelect = document.getElementById('timePeriodSelect');
            const filterForm = document.getElementById('filterForm');

            if (accountSelect) {
                accountSelect.addEventListener('change', function() {
                    if (this.value === 'create_new') {
                        window.location.href = '@Url.Action("Create", "AccountSetup")';
                    } else {
                        filterForm.submit();
                    }
                });
            }
            if (timePeriodSelect) {
                timePeriodSelect.addEventListener('change', function() {
                    filterForm.submit();
                });
            }

            // --- CHART RENDERING ---
            const expenseData = @Html.Raw(JsonSerializer.Serialize(Model.ExpenseChartData));
            if (expenseData && expenseData.Values.length > 0) {
                const defaultExpenseText = expenseData.Labels[0];
                const expenseCtx = document.getElementById('expenseChart').getContext('2d');
                const expenseChart = new Chart(expenseCtx, {
                    type: 'doughnut',
                    plugins: [doughnutCenterText],
                    data: {
                        labels: expenseData.Labels,
                        datasets: [{
                            data: expenseData.Values,
                            backgroundColor: expenseData.Colors,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        cutout: '70%',
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            doughnutCenterText: { text: defaultExpenseText }
                        },
                        onHover: (event, chartElement) => {
                            const activeElements = chartElement || [];
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                const label = expenseChart.data.labels[index];
                                expenseChart.options.plugins.doughnutCenterText.text = label;
                            } else {
                                expenseChart.options.plugins.doughnutCenterText.text = defaultExpenseText;
                            }
                            expenseChart.update('none');
                        }
                    }
                });
            } else {
                createPlaceholderChart('expenseChart');
            }

            const incomeData = @Html.Raw(JsonSerializer.Serialize(Model.IncomeChartData));
            if (incomeData && incomeData.Values.length > 0) {
                const defaultIncomeText = incomeData.Labels[0];
                const incomeCtx = document.getElementById('incomeChart').getContext('2d');
                const incomeChart = new Chart(incomeCtx, {
                    type: 'doughnut',
                    plugins: [doughnutCenterText],
                    data: {
                        labels: incomeData.Labels,
                        datasets: [{
                            data: incomeData.Values,
                            backgroundColor: incomeData.Colors,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        cutout: '70%',
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            doughnutCenterText: { text: defaultIncomeText }
                        },
                        onHover: (event, chartElement) => {
                            const activeElements = chartElement || [];
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                const label = incomeChart.data.labels[index];
                                incomeChart.options.plugins.doughnutCenterText.text = label;
                            } else {
                                incomeChart.options.plugins.doughnutCenterText.text = defaultIncomeText;
                            }
                            incomeChart.update('none');
                        }
                    }
                });
            } else {
                createPlaceholderChart('incomeChart');
            }
        });
    </script>
}